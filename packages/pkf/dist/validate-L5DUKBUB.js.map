{"version":3,"sources":["../src/commands/validate.ts"],"sourcesContent":["/**\r\n * Validate Command\r\n * Runs all PKF validations\r\n */\r\n\r\nimport { existsSync, readFileSync, readdirSync } from 'node:fs';\r\nimport { join, extname } from 'node:path';\r\nimport { spawn, execSync } from 'node:child_process';\r\nimport chalk from 'chalk';\r\n\r\ninterface ValidateOptions {\r\n  config?: string;\r\n  structure?: boolean;\r\n  content?: boolean;\r\n  fix?: boolean;\r\n}\r\n\r\ninterface ValidationResult {\r\n  category: string;\r\n  errors: number;\r\n  warnings: number;\r\n  messages: string[];\r\n}\r\n\r\nexport async function validateCommand(options: ValidateOptions): Promise<void> {\r\n  const cwd = process.cwd();\r\n  const configPath = options.config || 'pkf.config.yaml';\r\n  const structurePath = join(cwd, '.pkf/generated/structure.json');\r\n\r\n  console.log(chalk.bold('\\nPKF Validate\\n'));\r\n\r\n  // Check if PKF is initialized\r\n  if (!existsSync(join(cwd, configPath))) {\r\n    console.log(chalk.red(`✗ PKF not initialized in this project`));\r\n    console.log(chalk.gray('  Run `pkf init` to initialize PKF.\\n'));\r\n    process.exit(1);\r\n  }\r\n\r\n  // Check if build artifacts exist\r\n  if (!existsSync(structurePath)) {\r\n    console.log(chalk.yellow('⚠ Build artifacts not found. Running build first...\\n'));\r\n    const { buildCommand } = await import('./build.js');\r\n    await buildCommand({ config: configPath });\r\n    console.log('');\r\n  }\r\n\r\n  const results: ValidationResult[] = [];\r\n  let totalErrors = 0;\r\n  let totalWarnings = 0;\r\n\r\n  // Run structure validation\r\n  if (!options.content) {\r\n    console.log(chalk.cyan('Validating structure...'));\r\n    const structureResult = await validateStructure(cwd, structurePath);\r\n    results.push(structureResult);\r\n    totalErrors += structureResult.errors;\r\n    totalWarnings += structureResult.warnings;\r\n  }\r\n\r\n  // Run content validation\r\n  if (!options.structure) {\r\n    console.log(chalk.cyan('Validating content...'));\r\n    const contentResult = await validateContent(cwd);\r\n    results.push(contentResult);\r\n    totalErrors += contentResult.errors;\r\n    totalWarnings += contentResult.warnings;\r\n  }\r\n\r\n  // Print results\r\n  console.log(chalk.bold('\\nValidation Summary:\\n'));\r\n\r\n  for (const result of results) {\r\n    const status = result.errors > 0\r\n      ? chalk.red('✗')\r\n      : result.warnings > 0\r\n        ? chalk.yellow('⚠')\r\n        : chalk.green('✓');\r\n\r\n    console.log(`${status} ${chalk.bold(result.category)}`);\r\n    console.log(chalk.gray(`  Errors: ${result.errors}, Warnings: ${result.warnings}`));\r\n\r\n    for (const msg of result.messages.slice(0, 5)) {\r\n      console.log(chalk.gray(`  - ${msg}`));\r\n    }\r\n\r\n    if (result.messages.length > 5) {\r\n      console.log(chalk.gray(`  ... and ${result.messages.length - 5} more`));\r\n    }\r\n    console.log('');\r\n  }\r\n\r\n  // Final status\r\n  console.log(chalk.bold('─'.repeat(40)));\r\n  if (totalErrors > 0) {\r\n    console.log(chalk.red.bold(`\\n✗ Validation failed`));\r\n    console.log(chalk.gray(`  ${totalErrors} error(s), ${totalWarnings} warning(s)\\n`));\r\n    process.exit(1);\r\n  } else if (totalWarnings > 0) {\r\n    console.log(chalk.yellow.bold(`\\n⚠ Validation passed with warnings`));\r\n    console.log(chalk.gray(`  ${totalWarnings} warning(s)\\n`));\r\n  } else {\r\n    console.log(chalk.green.bold(`\\n✓ All validations passed\\n`));\r\n  }\r\n}\r\n\r\nasync function validateStructure(cwd: string, structurePath: string): Promise<ValidationResult> {\r\n  const result: ValidationResult = {\r\n    category: 'Structure',\r\n    errors: 0,\r\n    warnings: 0,\r\n    messages: [],\r\n  };\r\n\r\n  // Find pkf-processor CLI\r\n  const pkfProcessorPaths = [\r\n    join(cwd, 'node_modules/.bin/pkf-processor'),\r\n    join(cwd, 'node_modules/@pantheon-tech/pkf-processor/dist/cli.js'),\r\n  ];\r\n\r\n  let pkfProcessorPath: string | null = null;\r\n  for (const p of pkfProcessorPaths) {\r\n    if (existsSync(p)) {\r\n      pkfProcessorPath = p;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (pkfProcessorPath) {\r\n    try {\r\n      const isJsFile = pkfProcessorPath.endsWith('.js');\r\n      const command = isJsFile ? `node ${pkfProcessorPath}` : pkfProcessorPath;\r\n\r\n      const output = execSync(`${command} validate-structure --structure ${structurePath} 2>&1`, {\r\n        cwd,\r\n        encoding: 'utf8',\r\n      });\r\n\r\n      // Parse output\r\n      const errorsMatch = output.match(/Errors:\\s+(\\d+)/);\r\n      const warningsMatch = output.match(/Warnings:\\s+(\\d+)/);\r\n\r\n      result.errors = errorsMatch ? parseInt(errorsMatch[1], 10) : 0;\r\n      result.warnings = warningsMatch ? parseInt(warningsMatch[1], 10) : 0;\r\n\r\n      // Extract messages\r\n      const errorLines = output.match(/ERROR \\[.*?\\] (.*)/g);\r\n      const warningLines = output.match(/WARNING \\[.*?\\] (.*)/g);\r\n\r\n      if (errorLines) {\r\n        result.messages.push(...errorLines.map(l => l.replace(/ERROR \\[.*?\\] /, '')));\r\n      }\r\n      if (warningLines) {\r\n        result.messages.push(...warningLines.map(l => l.replace(/WARNING \\[.*?\\] /, '')));\r\n      }\r\n    } catch (error: any) {\r\n      const output = error.stdout || error.stderr || '';\r\n      const errorsMatch = output.match(/Errors:\\s+(\\d+)/);\r\n      const warningsMatch = output.match(/Warnings:\\s+(\\d+)/);\r\n\r\n      result.errors = errorsMatch ? parseInt(errorsMatch[1], 10) : 1;\r\n      result.warnings = warningsMatch ? parseInt(warningsMatch[1], 10) : 0;\r\n\r\n      const errorLines = output.match(/ERROR \\[.*?\\] (.*)/g);\r\n      if (errorLines) {\r\n        result.messages.push(...errorLines.map((l: string) => l.replace(/ERROR \\[.*?\\] /, '')));\r\n      }\r\n    }\r\n  } else {\r\n    // Fallback: basic structure check\r\n    const docsDir = join(cwd, 'docs');\r\n    if (!existsSync(docsDir)) {\r\n      result.errors++;\r\n      result.messages.push('docs/ directory not found');\r\n    }\r\n\r\n    const readmeFile = join(docsDir, 'README.md');\r\n    if (existsSync(docsDir) && !existsSync(readmeFile)) {\r\n      result.errors++;\r\n      result.messages.push('docs/README.md not found');\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nasync function validateContent(cwd: string): Promise<ValidationResult> {\r\n  const result: ValidationResult = {\r\n    category: 'Content',\r\n    errors: 0,\r\n    warnings: 0,\r\n    messages: [],\r\n  };\r\n\r\n  const docsDir = join(cwd, 'docs');\r\n  if (!existsSync(docsDir)) {\r\n    return result;\r\n  }\r\n\r\n  // Check markdown files for basic issues\r\n  const checkDir = (dir: string) => {\r\n    try {\r\n      const files = readdirSync(dir, { withFileTypes: true });\r\n      for (const file of files) {\r\n        const filePath = join(dir, file.name);\r\n        if (file.isDirectory()) {\r\n          checkDir(filePath);\r\n        } else if (extname(file.name) === '.md') {\r\n          const content = readFileSync(filePath, 'utf8');\r\n          const relativePath = filePath.replace(cwd + '/', '');\r\n\r\n          // Check for title\r\n          if (!content.match(/^#\\s+/m)) {\r\n            result.warnings++;\r\n            result.messages.push(`${relativePath}: Missing title heading`);\r\n          }\r\n\r\n          // Check for empty file\r\n          if (content.trim().length === 0) {\r\n            result.errors++;\r\n            result.messages.push(`${relativePath}: Empty file`);\r\n          }\r\n\r\n          // Check for broken internal links\r\n          const linkPattern = /\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\r\n          let match;\r\n          while ((match = linkPattern.exec(content)) !== null) {\r\n            const linkPath = match[2];\r\n            if (!linkPath.startsWith('http') && !linkPath.startsWith('#')) {\r\n              const resolvedPath = join(dir, linkPath);\r\n              if (!existsSync(resolvedPath)) {\r\n                result.warnings++;\r\n                result.messages.push(`${relativePath}: Broken link to ${linkPath}`);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch {\r\n      // Ignore read errors\r\n    }\r\n  };\r\n\r\n  checkDir(docsDir);\r\n\r\n  return result;\r\n}\r\n"],"mappings":"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","names":[]}